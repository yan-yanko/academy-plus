<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>אקדמיה פלוס</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <script src="src/config/config.js"></script>
    <script>
        console.log('Script loaded');
        
        // User data
        let userData = {
            firstName: "משתמש", // Default name
            lastName: "",
            email: ""
        };
        
        // Chat flow logic
        let currentState = "initial";
        let selectedCluster = "";
        let selectedOccupation = "";
        let selectedSkill = "";

        // Add a bot message to the chat
        function addBotMessage(text, options = null, fileUpload = false, isLoading = false) {
            const chatContainer = document.getElementById('chat-container');
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message bot-message';
            
            const avatarDiv = document.createElement('div');
            avatarDiv.className = 'avatar bot-avatar';
            avatarDiv.innerText = 'AI';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            if (isLoading) {
                contentDiv.innerHTML = '<div class="loading-indicator"><span></span><span></span><span></span></div>';
            } else {
                contentDiv.innerHTML = text;
            }
            
            messageDiv.appendChild(avatarDiv);
            messageDiv.appendChild(contentDiv);
            
            if (options && !isLoading) {
                const optionsContainer = document.createElement('div');
                optionsContainer.className = 'options-container';
                
                options.forEach(option => {
                    const button = document.createElement('button');
                    button.className = 'option-button';
                    button.innerText = option.text;
                    button.onclick = () => handleOptionClick(option.action, option.text);
                    optionsContainer.appendChild(button);
                });
                
                contentDiv.appendChild(optionsContainer);
            }
            
            if (fileUpload && !isLoading) {
                const fileUploadDiv = document.createElement('div');
                fileUploadDiv.className = 'file-upload';
                fileUploadDiv.innerHTML = '<p>לחץ כאן להעלאת קובץ הסילבוס שלך<br>(תומך ב-PPT, PDF, Word)</p>';
                fileUploadDiv.onclick = () => simulateFileUpload();
                
                contentDiv.appendChild(fileUploadDiv);
            }
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            return messageDiv;
        }

        // Add a user message to the chat
        function addUserMessage(text) {
            const chatContainer = document.getElementById('chat-container');
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message user-message';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.innerText = text;
            
            const avatarDiv = document.createElement('div');
            avatarDiv.className = 'avatar user-avatar';
            avatarDiv.innerText = userData.firstName.charAt(0);
            
            messageDiv.appendChild(contentDiv);
            messageDiv.appendChild(avatarDiv);
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Start the chat with welcome message
        function startChat() {
            console.log('Starting chat...');
            addBotMessage(`שלום ${userData.firstName}, נעים להכיר. אני עוזר הוראה מבוסס בינה מלאכותית המתמחה בזיהוי והטמעת מיומנויות תעסוקתיות בקורסים אקדמיים. אנתח את תוכן הקורס שלך, אזהה מיומנויות רלוונטיות לשוק העבודה, ואציע דרכים מעשיות לשילובן בהוראה שלך.`);
            
            setTimeout(() => {
                addBotMessage(`בוא נתחיל מהעלאת הסילבוס שאתה מתכוון ללמד.`, [
                    { text: "העלאת סילבוס", action: "uploadSyllabus" }
                ]);
            }, 1000);
        }
        
        // Initialize the chat when page loads
        window.onload = function() {
            console.log('Window loaded');
            // Allow sending message with Enter key
            document.getElementById('message-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            // Initialize the app
            initializeApp();
        };
        
        // טעינת משתנה הסביבה מ-Netlify
        window.initializeApp = async function() {
            console.log('Starting initializeApp...');
            try {
                console.log('Fetching API key from Netlify...');
                const response = await fetch('/.netlify/functions/get-api-key');
                console.log('Response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                console.log('Data received:', { hasApiKey: !!data.apiKey });
                window.OPENAI_API_KEY = data.apiKey;
                config.openai.key = data.apiKey; // עדכון המפתח בקונפיג
                console.log('API key loaded successfully');
                startChat();
            } catch (error) {
                console.error('Error loading API key:', error);
            }
        };

        [שאר הקוד ללא שינוי...]
